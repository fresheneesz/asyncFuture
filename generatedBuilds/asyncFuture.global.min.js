/* Copyright (c) 2013 Billy Tetrud - Free to use for any purpose: MIT License*/
!function(r){function t(r){if(arguments.length>0){var e=new t;return e.return(r),e}this.resolved=!1,this.queue=[],t.debug&&(a++,this.id=a)}function e(r,e){if(!(e instanceof t)&&void 0!==e)throw Error("Value returned from then or catch *not* a Future: "+e);i(r,"next",e)}function n(r,t){r.resolved?s(r,[t]):r.queue.push(t)}function o(r,t,i){n(t,function(){if(this.hasError)r.throw(this.error);else if(this.hasNext)o(r,this.next,i);else try{e(r,i(this.result))}catch(t){r.throw(t)}})}function i(r,t,e){if(r.resolved)throw Error("Future resolved more than once! Resolution: "+e);r.resolved=!0,r.hasError="error"===t,r.hasNext="next"===t&&void 0!==e,r.hasError?r.error=e:r.hasNext?r.next=e:r.result=e,s(r,r.queue)}function s(r,t){t.length>0&&setTimeout(function(){t.forEach(function(t){t.apply(r)})},0)}var u={exports:r},h=require("trimArguments");u.exports=t,t.debug=!1;var a=0;t.all=function(){if(arguments[0]instanceof Array)var r=arguments[0];else var r=h(arguments);var e=new t,n=[];if(r.length>0){var o=r[0];r.forEach(function(t,e){o=o.then(function(t){return n[e]=t,r[e+1]})}),o.catch(function(r){e.throw(r)}),o.then(function(){e.return(n)})}else e.return(n);return e},t.wrap=function(){if(1===arguments.length)var r=arguments[0],e=void 0;else var e=arguments[0],r=e[arguments[1]];return function(){var n=Array.prototype.slice.call(arguments),o=new t;n.push(o.resolver());var i=this;return e&&(i=e),r.apply(i,n),o}};var c=function(r){setTimeout(function(){throw r},0)};t.error=function(r){c=r},t.prototype.return=function(r){i(this,"return",r)},t.prototype.throw=function(r){i(this,"error",r)},t.prototype.then=function(r){var i=new t;return n(this,function(){if(this.hasError)i.throw(this.error);else if(this.hasNext)o(i,this.next,r);else try{e(i,r(this.result))}catch(t){i.throw(t)}}),i},t.prototype.catch=function(r){var o=new t;return n(this,function(){if(this.hasError)try{e(o,r(this.error))}catch(t){o.throw(t)}else this.hasNext?e(o,this.next):o.return(this.result)}),o},t.prototype.finally=function(r){var e=new t;return n(this,function(){try{r(),this.hasError?e.throw(this.error):e.return(this.result)}catch(t){e.throw(t)}}),e},t.prototype.done=function(){n(this,function(){this.hasError&&c(this.error)})},t.prototype.resolver=function(){var r=this;return function(t,e){t?r.throw(t):r.return(e)}},t.prototype.isResolved=function(){return this.resolved}}(this);